<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Fills the screen, doesn't scroll or zoom -->
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title></title>

    <link rel="manifest" href="manifest.json">

    <!-- un-comment this code to enable service worker
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('service-worker.js')
          .then(() => console.log('service worker installed'))
          .catch(err => console.log('Error', err));
      }
    </script>-->

    <link href="lib/ionic/css/ionic.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <!-- IF using Sass (run gulp sass first), then uncomment below and remove the CSS includes above
    <link href="css/ionic.app.css" rel="stylesheet">
    -->

    <!-- ionic/angularjs js -->
    <script src="lib/ionic/js/ionic.bundle.js"></script>

    <!-- cordova script (this will be a 404 during development) -->
    <script src="cordova.js"></script>

    <!-- your app's js -->
    <script src="js/app.js"></script>

    <!-- Les scripts de la bibliothéque Js-AruCo -->
    <script type="text/javascript" src="js/polyfill.js"></script> 
    <script type="text/javascript" src="js/cv.js"></script> 
    <script type="text/javascript" src="js/aruco.js"></script>
    <script type="text/javascript" src="js/actionBar.js"></script>
    <script type="text/javascript" src="js/buttonHandler.js"></script>

    
    <!-- Traitement d'image -->
    <script>
    var video, canvas, context, imageData, detector;
  
    function onLoad(){
      video = document.querySelector('video');
      canvas = document.querySelector('canvas');
      context = canvas.getContext("2d");
      //Canvas prendre les dimensions de la fenétre 
      //qu'il le contien
      canvas.width = parseInt(window.innerWidth);
      canvas.height = parseInt(window.innerHeight);
    
      //Vérifier que le device support le WebRTC
      function hasGetUserMedia() {
        return !!(navigator.getUserMedia || navigator.webkitGetUserMedia ||
                  navigator.mozGetUserMedia || navigator.msGetUserMedia);
      }
      if (hasGetUserMedia()) {
  
        function successCallback(stream){
          if (window.webkitURL) {
            video.src = window.webkitURL.createObjectURL(stream);
          } else if (video.mozSrcObject !== undefined) {
            video.mozSrcObject = stream;
          } else {
            video.src = stream;
          }
        }
        
        function errorCallback(error){
          //Rien a faire
        }

        //Pour lister les différente materiel Media 
        navigator.mediaDevices.enumerateDevices()
        .then(function(devices) {
          devices.forEach(function(device) {
            console.log(device.kind + ": " + device.label +
                        " id = " + device.deviceId);
            if (device.kind == "videoinput") {
              //ToDo
            };
          });
        })
        .catch(function(err) {
            console.log(err.name + ": " + error.message);
        });
        
        //Qualité de la video HD(1280x720)
          navigator.getUserMedia({ video: { 
                                  width: 1280,
                                  height: 720,
                                  deviceId: device.deviceId ? {exact: device.deviceId} : undefined
                                   }
                                },
                                successCallback,
                                errorCallback
                              );
        detector = new AR.Detector();
        requestAnimationFrame(tick);
        
        } else {
          alert('getUserMedia() is not supported in your device');
        }
    }
    
    function tick(){
      requestAnimationFrame(tick);
      
      if (video.readyState === video.HAVE_ENOUGH_DATA){
        snapshot();

        var markers = detector.detect(imageData);
        drawCorners(markers);
        drawId(markers);
      }
    }
    //Gestion de la rotation de l'écran
    function rotationListener(){
          
      window.addEventListener("orientationchange", function() {
            switch (window.orientation) {
              case 0:
                  canvas.width = parseInt(window.innerHeight);
                  canvas.height = parseInt(window.innerWidth);

                  this.screenOrientation = 'portrait';
                  break;
              case 90:
                  canvas.width = parseInt(window.innerHeight);
                  canvas.height = parseInt(window.innerWidth);
                  this.screenOrientation = 'landscape';
                  break;
              case 180:
                  canvas.width = parseInt(window.innerHeight);
                  canvas.height = parseInt(window.innerWidth);
                  this.screenOrientation = 'portrait';
                  break;
              case -90:
                  canvas.width = parseInt(window.innerHeight);
                  canvas.height = parseInt(window.innerWidth);
                  this.screenOrientation = 'landscape';
                  break;
              default:
                  this.screenOrientation = 'unknown';
          }
       
      }, false);
    }   
    function snapshot(){
      //Quand il y a pas de marqueur dans le flux video le button correspendant disparaitre
      hideButton("lampe");

      rotationListener();
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      imageData = context.getImageData(0, 0, canvas.width, canvas.height);
      
    }
          
    function drawCorners(markers){
      var corners, corner, i, j;
    
      context.lineWidth = 3;

      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        context.strokeStyle = "red";
        context.beginPath();
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          context.moveTo(corner.x, corner.y);
          corner = corners[(j + 1) % corners.length];
          context.lineTo(corner.x, corner.y);
        }

        context.stroke();
        context.closePath();
        
        context.strokeStyle = "green";
        context.strokeRect(corners[0].x - 2, corners[0].y - 2, 4, 4);
      }
    }

    function drawId(markers){
      var corners, corner, x, y, i, j;
      
      context.strokeStyle = "blue";
      context.lineWidth = 1;
      
      for (i = 0; i !== markers.length; ++ i){
        corners = markers[i].corners;
        
        x = Infinity;
        y = Infinity;
        xMax = 0 ;
        yMax = 0 ;
        
        for (j = 0; j !== corners.length; ++ j){
          corner = corners[j];
          
          x = Math.min(x, corner.x);
          y = Math.min(y, corner.y);
          xMax = Math.max(x, corner.x);
          yMax = Math.max(y, corner.y);
        }
        //Marqueur de la lampe detecter ID = 10
        if( markers[i].id == 10)
          showButton(x,xMax,y,yMax)  
        else
          hideButton("lampe");
      
        context.strokeText(markers[i].id, x, y)
      }
    }
    function actionLampe(){
      alert("ToDo Actions Lampe");
    }
    window.onload = onLoad;
  </script>
  
  </head>
  <body ng-app="starter">

    <ion-pane>

      <ion-header-bar align-title="left" class="bar-positive">
        <div class="buttons">
          <button class="button" ng-click="doSomething()">Setting</button>
        </div>
        <h1 class="title"></h1>
        <div class="buttons">
          <button class="button" onclick="doExit()">Exit</button>
        </div>
      </ion-header-bar>
      
      <ion-content class="has-header">
      <div id="myDiv">
        <button id="lampe" class="btnAR" style="display:none;" onclick="actionLampe()">Lampe</button>
        <video id="video" autoplay="true" style="display:none;" ></video>
        <canvas id="canvas" ></canvas>
      </div>
      </ion-content>
   
    </ion-pane>
  </body>
</html>
